openapi: 3.0.0
info:
  title: API de Usuarios (JSON & XML) Talento Lab
  description: API desarrollada para el curso de Testing QA.
  version: 1.0.0

tags:
  - name: JSON
    description: Endpoints con respuestas en formato JSON
  - name: XML
    description: Endpoints con respuestas en formato XML

paths:
  # ----------------------------------------------------
  # RUTAS BASE: LISTAR (GET) Y CREAR (POST)
  # ----------------------------------------------------
  /json:
    get:
      summary: Listar todos los usuarios (JSON)
      tags: [JSON]
      responses:
        200:
          description: Lista obtenida correctamente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UsuarioResponse'
        429:
          $ref: '#/components/responses/RateLimitError'
        500:
          $ref: '#/components/responses/ServerErrorJSON'

    post:
      summary: Crear nuevo usuario con CV (JSON)
      tags: [JSON]
      description: Crea un usuario y permite subir el archivo CV.
      requestBody:
        $ref: '#/components/requestBodies/UsuarioMultipart'
      responses:
        201:
          description: Usuario creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  mensaje:
                    type: string
                    example: "Usuario creado"
                  usuario:
                    $ref: '#/components/schemas/UsuarioResponse'
        429:
          $ref: '#/components/responses/RateLimitError'
        500:
          description: Error al crear usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Error al crear usuario"

  /xml:
    get:
      summary: Listar todos los usuarios (XML)
      tags: [XML]
      responses:
        200:
          description: Lista obtenida correctamente
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: usuarios # <--- Define el root tag <usuarios>
                properties:
                  usuario:
                    type: array
                    items:
                      $ref: '#/components/schemas/UsuarioResponse'
        429:
          $ref: '#/components/responses/RateLimitErrorXML'
        500:
          $ref: '#/components/responses/ServerErrorXML'

    post:
      summary: Crear nuevo usuario con CV (XML)
      tags: [XML]
      description: Crea un usuario y permite subir el archivo CV.
      requestBody:
        $ref: '#/components/requestBodies/UsuarioMultipart'
      responses:
        201:
          description: Usuario creado exitosamente
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: root # <--- xml2js usa 'root' por defecto cuando hay varias props
                properties:
                  mensaje:
                    type: string
                    example: "Usuario creado"
                  usuario:
                    $ref: '#/components/schemas/UsuarioResponse'
        429:
          $ref: '#/components/responses/RateLimitErrorXML'
        500:
          $ref: '#/components/responses/ServerErrorXML'

  # ----------------------------------------------------
  # RUTAS POR ID: OBTENER, ELIMINAR Y ACTUALIZAR
  # ----------------------------------------------------
  /json/{id}:
    get:
      summary: Obtener usuario por ID (JSON)
      tags: [JSON]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        200:
          description: Usuario encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsuarioResponse'
        404:
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Usuario no encontrado"
        429:
          $ref: '#/components/responses/RateLimitError'
        500:
          $ref: '#/components/responses/ServerErrorJSON'

    delete:
      summary: Eliminar usuario (JSON)
      tags: [JSON]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        200:
          description: Usuario eliminado correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  mensaje:
                    type: string
                    example: "Usuario eliminado correctamente"
        404:
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Usuario no encontrado para eliminar"
        429:
          $ref: '#/components/responses/RateLimitError'
        500:
          $ref: '#/components/responses/ServerErrorJSON'

    put:
      summary: Actualizar usuario y/o CV (JSON)
      tags: [JSON]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        $ref: '#/components/requestBodies/UsuarioMultipart'
      responses:
        200:
          description: Usuario actualizado correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  mensaje:
                    type: string
                    example: "Usuario actualizado correctamente"
                  usuario:
                    $ref: '#/components/schemas/UsuarioResponse'
        404:
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Usuario no encontrado para actualizar"
        429:
          $ref: '#/components/responses/RateLimitError'
        500:
          $ref: '#/components/responses/ServerErrorJSON'

  /xml/{id}:
    get:
      summary: Obtener usuario por ID (XML)
      tags: [XML]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        200:
          description: Usuario encontrado
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: usuario # <--- Root tag <usuario>
                properties:
                  usuario: # Wrapper interno si xml2js lo genera así, o directo ref
                    $ref: '#/components/schemas/UsuarioResponse'
        404:
          description: Usuario no encontrado
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: error # <--- Root tag <error>
                properties:
                  message:
                     type: string
                     example: "Usuario no encontrado"
        429:
          $ref: '#/components/responses/RateLimitErrorXML'
        500:
          $ref: '#/components/responses/ServerErrorXML'

    delete:
      summary: Eliminar usuario (XML)
      tags: [XML]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        200:
          description: Usuario eliminado correctamente
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: root
                properties:
                  mensaje:
                    type: string
                    example: "Usuario eliminado correctamente"
        404:
          description: Usuario no encontrado
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: error
                properties:
                  message:
                    type: string
                    example: "Usuario no encontrado para eliminar"
        429:
          $ref: '#/components/responses/RateLimitErrorXML'
        500:
          $ref: '#/components/responses/ServerErrorXML'

    put:
      summary: Actualizar usuario y/o CV (XML)
      tags: [XML]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        $ref: '#/components/requestBodies/UsuarioMultipart'
      responses:
        200:
          description: Usuario actualizado correctamente
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: root
                properties:
                  mensaje:
                    type: string
                    example: "Usuario actualizado correctamente"
                  usuario:
                    $ref: '#/components/schemas/UsuarioResponse'
        404:
          description: Usuario no encontrado
          content:
            application/xml:
              schema:
                type: object
                xml:
                  name: error
                properties:
                   message:
                    type: string
                    example: "Usuario no encontrado para actualizar"
        429:
          $ref: '#/components/responses/RateLimitErrorXML'
        500:
          $ref: '#/components/responses/ServerErrorXML'

# ----------------------------------------------------
# COMPONENTES REUTILIZABLES
# ----------------------------------------------------
components:
  parameters:
    IdParam:
      name: id
      in: path
      required: true
      description: Identificador único del usuario
      schema:
        type: string
        example: "64b8f9e2d3e1a123456789ab"

  responses:
    RateLimitError:
      description: Demasiadas peticiones (Rate Limit)
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Límite de peticiones excedido"
              mensaje:
                type: string
                example: "Estás realizando demasiadas consultas muy rápido. Espera 5 minutos."

    RateLimitErrorXML:
      description: Demasiadas peticiones (Rate Limit)
      content:
        application/xml:
          schema:
            type: object
            xml:
              name: error # <--- Root tag para el error XML
            properties:
              error:
                type: string
                example: "Límite de peticiones excedido"
              mensaje:
                type: string
                example: "Estás realizando demasiadas consultas muy rápido. Espera 5 minutos."

    ServerErrorJSON:
      description: Error interno del servidor
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Error al procesar la solicitud"
              err:
                type: string
                example: "Detalles técnicos del error..."

    ServerErrorXML:
      description: Error interno del servidor
      content:
        application/xml:
          schema:
            type: object
            xml:
              name: error
            properties:
              message:
                 type: string
                 example: "Error al procesar la solicitud"

  requestBodies:
    UsuarioMultipart:
      required: true
      content:
        multipart/form-data:
          schema:
            type: object
            properties:
              nombre:
                type: string
                description: Nombre del usuario
                example: "Daniel García"
              email:
                type: string
                format: email
                description: Correo electrónico
                example: "daniel.garcia@talentolab.com"
              contrasena:
                type: string
                format: password
                description: Contraseña del usuario
                example: "pass1234"
              cv:
                type: string
                format: binary
                description: Archivo del Curriculum Vitae (opcional en PUT, requerido en POST si aplica)

  schemas:
    UsuarioResponse:
      type: object
      # ------------------------------------------
      # ESTA ES LA CLAVE PARA QUE XML FUNCIONE
      # ------------------------------------------
      xml:
        name: usuario
      properties:
        _id:
          type: string
          description: Identificador interno del sistema
          example: "64b8f9e2d3e1a123456789ab"
        nombre:
          type: string
          example: "Daniel García"
        email:
          type: string
          format: email
          example: "daniel.garcia@talentolab.com"
        cv:
          type: string
          description: Ruta relativa del archivo subido
          example: "uploads/curriculum-2025.pdf"